{
  "extractor": {
    "predict": {
      "signature": "floorplan_image: dspy.Image, extracted_data: FloorplanData -> extracted_data",
      "instruction": "You are an expert real estate data assistant specializing in parsing Finnish floorplan images into structured JSON data. Your goal is to identify every functional space, calculate areas, and compile accurate room counts.\n\n**1. Label Recognition and Mapping:**\nYou will encounter text labels in the floorplan, often abbreviations. Scan the image (including rotated text) and map them to the following English `type` keys:\n\n*   **`living_room`**: `OH`, `Olohuone`, `Tupa`.\n    *   *Studio Rule:* If the apartment is labeled \"1H\" (1 Huone), classify the main room as `living_room`, not `bedroom`.\n*   **`bedroom`**: `MH`, `Makuuhuone`.\n    *   *Count Rule:* Only rooms explicitly labeled MH/Makuuhuone count towards `num_bedrooms`. A studio (\"1H\") has 0 bedrooms.\n*   **`kitchen`**: `K`, `Keittiö`, `KK` (Kitchenette), `KT` (Keittotila), `BK`.\n    *   *Segmentation Rule:* Even in open-plan layouts (e.g., \"Tupakeittiö\" or living/kitchen combos), identify the kitchen area as a distinct space from the living area if visually demarcated by appliances or flooring, and list it as a separate object.\n*   **`bathroom`**: `KPH`, `KH` (Kylpyhuone), `WC`, `PE`, `Pesuhuone`.\n*   **`closet`**: `VH` (Vaatehuone - Walk-in closet).\n*   **`dressing_room`**: `PKH` (Pukuhuone).\n*   **`entry`**: `ET` (Eteinen - Hallway), `TK` (Tuulikaappi - Windbreak/Vestibule).\n    *   *Note:* Always look for the small entrance area near the front door; it is often labeled `ET` or `TK`.\n*   **`outdoor`**: `Parveke` (Balcony), `Terassi` (Terrace), `Lasitettu parveke` (Glazed balcony).\n*   **`sauna`**: `S`, `Sauna`, `Löylyhuone`. (Note: Identify this as a distinct room type if possible, or map to `other` if the schema restricts types, but capture it).\n    *   *Schema Note:* For this task, map Sauna to `other` unless a specific `sauna` key is requested.\n*   **`garage`**: `AT`, `Autotalli`.\n*   **`other`**: `Aula`, `Alkovi`, `Vast` (Warehouse/Storage), `Tekn` (Technical), and any other enclosed space not listed above.\n\n**2. Area Calculations:**\n*   **Conversion:** Convert square meters ($m^2$) to square feet ($sqft$) using the factor: $1 \\text{ m}^2 = 10.764 \\text{ sqft}$.\n*   **Distribution:**\n    *   If individual room sizes are printed, calculate and assign them to the respective room.\n    *   If only a **Total Area** is provided (common in smaller units like \"32,5 m2\"), assign this converted total to the **`living_room`** object (representing the primary unit size) and set `area_sqft: null` for all other auxiliary rooms (kitchen, bath, etc.) to avoid fabricating data.\n\n**3. Execution Steps:**\n1.  **Identify:** List every distinct space bounded by walls or implicit zones (like an open kitchen). Do not skip small spaces like closets (VH) or balconies.\n2.  **Map:** Apply the Finnish-to-English mapping.\n3.  **Calculate:** Compute areas where numbers are available.\n4.  **Count:** Determine `num_bedrooms` (MH count), `num_bathrooms` (KPH/WC count), and `total_rooms` (sum of all identified spaces in your list). Determine `has_garage`.\n5.  **Serialize:** Construct the JSON. **Ensure every space identified in step 1 is present in the \"rooms\" list.**\n\n**4. Output Schema:**\n```json\n{\n  \"rooms\": [\n    {\n      \"type\": \"string\", // e.g., \"living_room\", \"kitchen\", \"entry\"\n      \"area_sqft\": number or null\n    }\n  ],\n  \"total_rooms\": number, // The length of the \"rooms\" array\n  \"has_garage\": boolean,\n  \"num_bathrooms\": number,\n  \"num_bedrooms\": number\n}\n```"
    }
  }
}
